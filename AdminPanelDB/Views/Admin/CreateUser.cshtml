@model AdminPanelDB.Models.Personen

<h2 style="text-align:center;">Benutzer erstellen</h2>

@if (ViewBag.Error != null)
{
    <p style="color:red; text-align:center; font-weight:bold;">
        @ViewBag.Error
    </p>
}

<div class="form-container">
    <form asp-action="CreateUser" method="post">
        <label asp-for="Titel">Titel:</label>
        <select asp-for="Titel" asp-items="ViewBag.TitelListe" class="form-control">
            <option value="">-- Select Titel --</option>
        </select>

        <label asp-for="Name">Name:</label>
        <input asp-for="Name" />

        <label asp-for="Vorname">Vorname:</label>
        <input asp-for="Vorname" />

        <label asp-for="Email">Email:</label>
        <input asp-for="Email" id="emailInput" />

        <label asp-for="UId">UId:</label>
        <input asp-for="UId" id="uidInput" readonly />

        <!-- Dropdown Abteilung. -->
        <label>Abteilung:</label>
        <select id="abteilungDropdown" name="Abteilung">
            <option value="">-- Abteilung auswählen --</option>
            @foreach (var abt in ViewBag.Abteilungen)
            {
                <option value="@abt.Name" data-id="@abt.Id">@abt.Name</option>
            }
        </select>

        <!-- Dropdown Referat. -->
        <label>Referat:</label>
        <select id="referatDropdown" name="Referat">
            <option value="">-- Referat auswählen --</option>
        </select>

        <label asp-for="Stelle">Stelle:</label>
        <input asp-for="Stelle" />

        <label asp-for="Kennwort">Kennwort:</label>
        <input asp-for="Kennwort" type="password" />

        <!-- Dropdown Rolle. -->
        <label asp-for="Rolle">Rolle:</label>
        <select asp-for="Rolle" asp-items="ViewBag.RolleListe" class="form-control" id="rolleSelect">
            <option value="">-- Select Rolle --</option>
        </select>


        <label asp-for="IstAdmin">Superadmin:</label>
        <input asp-for="IstAdmin" type="checkbox" disabled="@(Context.Session.GetInt32("IstAdmin") != 1)" id="istAdminCheckbox" />



        <button type="submit">Speichern</button>
    </form>
    <a asp-action="Personen">Züruck</a>
</div>


<script>
    document.getElementById("abteilungDropdown").addEventListener("change", function () {
        var abteilungId = this.options[this.selectedIndex].getAttribute("data-id");
        var referatDropdown = document.getElementById("referatDropdown");

        fetch('/Admin/GetReferateByAbteilung?abteilungId=' + abteilungId)
            .then(response => response.json())
            .then(data => {
                referatDropdown.innerHTML = '<option value="">-- Select Referat --</option>';
                data.forEach(ref => {
                    var opt = document.createElement("option");
                    opt.value = ref.name;
                    opt.textContent = ref.name;
                    referatDropdown.appendChild(opt);
                });
            });
    });

     //Uid = email.
     document.getElementById("emailInput").addEventListener("input", function () {
            var email = this.value;
            var uid = "";
            if (email.indexOf("@@") !== -1) {
                uid = email.split("@@")[0];
            }
            document.getElementById("uidInput").value = uid;
        });


        // istAdmin aktiv nur wenn Rolle = Administrator.
        document.addEventListener("DOMContentLoaded", function () {
        var rolleSelect = document.getElementById("rolleSelect");
        var istAdminCheckbox = document.getElementById("istAdminCheckbox");

        function updateIstAdminState() {
            if (rolleSelect.value === "Administrator") {
                istAdminCheckbox.disabled = false;
            } else {
                istAdminCheckbox.checked = false;
                istAdminCheckbox.disabled = true;
            }
        }

        rolleSelect.addEventListener("change", updateIstAdminState);

        // Initial state.
        updateIstAdminState();
    });
</script>


