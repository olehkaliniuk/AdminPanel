@model AdminPanelDB.Models.Personen

<h2 style="text-align:center;">Benutzer bearbeiten</h2>

@if (ViewBag.Error != null)
{
    <p style="color:red; text-align:center; font-weight:bold;">
        @ViewBag.Error
    </p>
}

<div class="form-container">
    <form asp-action="EditUser" method="post">
        <input type="hidden" asp-for="Id" />

        <!-- Versteckte Felder für Pagination und Sortierung. -->
        <input type="hidden" name="pageNumber" value="@ViewBag.PageNumber" />
        <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
        <input type="hidden" name="sortColumn" value="@ViewBag.SortColumn" />
        <input type="hidden" name="sortDirection" value="@ViewBag.SortDirection" />

        <label asp-for="Titel">Titel:</label>
        <select asp-for="Titel" asp-items="ViewBag.TitelListe" class="form-control">
            <option value="">-- Select Titel --</option>
        </select>

        <label asp-for="Name">Name:</label>
        <input asp-for="Name" />

        <label asp-for="Vorname">Vorname:</label>
        <input asp-for="Vorname" />

        <label asp-for="Email">Email:</label>
        <input asp-for="Email" id="emailInput" />

        <label asp-for="UId">UId:</label>
        <input asp-for="UId" id="uidInput" readonly />

        <label>Abteilung:</label>
        <select id="abteilungDropdown" name="Abteilung">
            <option value="">-- Abteilung auswählen --</option>
            @foreach (var abt in ViewBag.Abteilungen)
            {
                if (Model.Abteilung != null && Model.Abteilung.Trim() == abt.Name.Trim())
                {
                    @Html.Raw($"<option value='{abt.Name}' data-id='{abt.Id}' selected>{abt.Name}</option>")
                }
                else
                {
                    @Html.Raw($"<option value='{abt.Name}' data-id='{abt.Id}'>{abt.Name}</option>")
                }
            }
        </select>

        <label>Referat:</label>
        <select id="referatDropdown" name="Referat">
            <option value="">-- Referat auswählen --</option>
            @if (ViewBag.Referate != null)
            {
                foreach (var refa in ViewBag.Referate)
                {
                    if (Model.Referat != null && Model.Referat.Trim() == refa.Name.Trim())
                    {
                        @Html.Raw($"<option value='{refa.Name.Trim()}' selected>{refa.Name}</option>")
                    }
                    else
                    {
                        @Html.Raw($"<option value='{refa.Name.Trim()}'>{refa.Name}</option>")
                    }
                }
            }
        </select>

        <label asp-for="Stelle">Stelle:</label>
        <input asp-for="Stelle" />

        <label>Passwort:</label>
        <input placeholder="********" readonly />

        <!-- Dropdown Rolle. -->
        <label asp-for="Rolle">Rolle:</label>
        <select asp-for="Rolle" asp-items="ViewBag.RolleListe" class="form-control" id="rolleSelect">
            <option value="">-- Select Rolle --</option>
        </select>

     
        <label asp-for="IstAdmin">IstAdmin:</label>
        <input asp-for="IstAdmin" type="checkbox" disabled="@(Context.Session.GetInt32("IstAdmin") != 1 || Context.Session.GetInt32("UserId") == Model.Id)" id="istAdminCheckbox" />



        <div style ="text-align:center;">
            <a asp-controller="Admin" asp-action="TKennwort" asp-route-userId="@Model.Id" class="abtn" style="text-decoration:none;">
                Temporäres Kennwort erstellen
            </a>
        </div>

        <button type="submit">Speichern</button>
    </form>

    <a asp-action="Personen"
       asp-route-pageNumber="@ViewBag.PageNumber"
       asp-route-pageSize="@ViewBag.PageSize"
       asp-route-sortColumn="@ViewBag.SortColumn"
       asp-route-sortDirection="@ViewBag.SortDirection">
        Zurück
    </a>
</div>


<script>
    document.getElementById("abteilungDropdown").addEventListener("change", function () {
        var abteilungId = this.options[this.selectedIndex].getAttribute("data-id");
        var referatDropdown = document.getElementById("referatDropdown");
        var currentReferat = referatDropdown.value; // Auswahl speichern.

        fetch('/Admin/GetReferateByAbteilung?abteilungId=' + abteilungId)
            .then(response => response.json())
            .then(data => {
                referatDropdown.innerHTML = '<option value="">-- Select Referat --</option>';
                data.forEach(ref => {
                    var opt = document.createElement("option");
                    opt.value = ref.name;
                    opt.textContent = ref.name;
                        if (ref.name.trim() === currentReferat.trim()) {
        opt.selected = true;
    }

                    referatDropdown.appendChild(opt);
                });
            });
    });



    //Uid = email
     document.getElementById("emailInput").addEventListener("input", function () {
            var email = this.value;
            var uid = "";
            if (email.indexOf("@@") !== -1) {
                uid = email.split("@@")[0];
            }
            document.getElementById("uidInput").value = uid;
        });



            // istAdmin aktiv nur wenn Rolle = Administrator
        document.addEventListener("DOMContentLoaded", function () {
        var rolleSelect = document.getElementById("rolleSelect");
        var istAdminCheckbox = document.getElementById("istAdminCheckbox");

        function updateIstAdminState() {
            if (rolleSelect.value === "Administrator") {
                istAdminCheckbox.disabled = false;
            } else {
                istAdminCheckbox.checked = false;
                istAdminCheckbox.disabled = true;
            }
        }

        rolleSelect.addEventListener("change", updateIstAdminState);

        // Initial state
        updateIstAdminState();
    });
</script>

